!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["sema-engine"]={})}(this,(function(exports){"use strict";class RingBuffer{static getStorageForCapacity(e,t){if(!t.BYTES_PER_ELEMENT)throw"Pass in a ArrayBuffer subclass";var o=8+(e+1)*t.BYTES_PER_ELEMENT;return new SharedArrayBuffer(o)}constructor(e,t){if(!ArrayBuffer.__proto__.isPrototypeOf(t)&&void 0!==t.BYTES_PER_ELEMENT)throw"Pass a concrete typed array class as second argument";this._type=t,this.capacity=(e.byteLength-8)/t.BYTES_PER_ELEMENT,this.buf=e,this.write_ptr=new Uint32Array(this.buf,0,1),this.read_ptr=new Uint32Array(this.buf,4,1),this.storage=new t(this.buf,8,this.capacity)}type(){return this._type.name}push(e){var t=Atomics.load(this.read_ptr,0),o=Atomics.load(this.write_ptr,0);if((o+1)%this._storage_capacity()==t)return 0;let r=Math.min(this._available_write(t,o),e.length),n=Math.min(this._storage_capacity()-o,r),s=r-n;return this._copy(e,0,this.storage,o,n),this._copy(e,n,this.storage,0,s),Atomics.store(this.write_ptr,0,(o+r)%this._storage_capacity()),r}pop(e){var t=Atomics.load(this.read_ptr,0),o=Atomics.load(this.write_ptr,0);if(o==t)return 0;let r=Math.min(this._available_read(t,o),e.length),n=Math.min(this._storage_capacity()-t,e.length),s=r-n;return this._copy(this.storage,t,e,0,n),this._copy(this.storage,0,e,n,s),Atomics.store(this.read_ptr,0,(t+r)%this._storage_capacity()),r}empty(){var e=Atomics.load(this.read_ptr,0);return Atomics.load(this.write_ptr,0)==e}full(){var e=Atomics.load(this.read_ptr,0);return(Atomics.load(this.write_ptr,0)+1)%this.capacity!=e}capacity(){return this.capacity-1}available_read(){var e=Atomics.load(this.read_ptr,0),t=Atomics.load(this.write_ptr,0);return this._available_read(e,t)}available_write(){var e=Atomics.load(this.read_ptr,0),t=Atomics.load(this.write_ptr,0);return this._available_write(e,t)}_available_read(e,t){return t>e?t-e:t+this._storage_capacity()-e}_available_write(e,t){let o=e-t-1;return t>=e&&(o+=this._storage_capacity()),o}_storage_capacity(){return this.capacity}_copy(e,t,o,r,n){for(var s=0;s<n;s++)o[r+s]=e[t+s]}}const getBase64=e=>{if(-1!==e.indexOf(";base64,")){var t=e.indexOf(";base64,")+8;return!!e.slice(t).match(/^([A-Za-z0-9+\/]{4})*([A-Za-z0-9+\/]{4}|[A-Za-z0-9+\/]{3}=|[A-Za-z0-9+\/]{2}==)$/)&&e.slice(t)}return!1},_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",removePaddingFromBase64=e=>64===Module.maxiTools._keyStr.indexOf(e.charAt(e.length-1))?e.substring(0,e.length-1):e,loadSampleToArray=(e,t,o,r)=>{var n=[],s=getBase64(o);if(s){var a=s.length/4*3,i=new ArrayBuffer(a);s=removePaddingFromBase64(removePaddingFromBase64(s));var l,p,u,c,d,h,m,f=parseInt(s.length/4*3,10),g=0,y=0;for(l=new Uint8Array(i),s=s.replace(/[^A-Za-z0-9\+\/\=]/g,""),g=0;g<f;g+=3)p=_keyStr.indexOf(s.charAt(y++))<<2|(d=_keyStr.indexOf(s.charAt(y++)))>>4,u=(15&d)<<4|(h=_keyStr.indexOf(s.charAt(y++)))>>2,c=(3&h)<<6|(m=_keyStr.indexOf(s.charAt(y++))),l[g]=p,64!==h&&(l[g+1]=u),64!==m&&(l[g+2]=c);e.decodeAudioData(i,(function(e){let o=e.getChannelData(0);void 0!==n&&void 0!==r&&r.port.postMessage({sample:t,buffer:o})}),(function(e){console.log("Error decoding source!")}))}else{var b=new XMLHttpRequest;b.addEventListener("load",(()=>console.info(`loading sample '${t}'`))),b.open("GET",o,!0),b.responseType="arraybuffer",b.onload=function(){e.decodeAudioData(b.response,(function(e){let o=e.getChannelData(0);void 0!==n&&void 0!==r&&r.port.postMessage({sample:t,buffer:o})}),(function(e){console.log("Error decoding source!")}))},b.send()}return"Loading module"};class Event{constructor(e){this.eventName=e,this.callbacks=[]}registerCallback(e){this.callbacks.push(e)}unregisterCallback(e){const t=this.callbacks.indexOf(e);t>-1&&this.callbacks.splice(t,1)}emit(e){this.callbacks.slice(0).forEach((t=>{t(e)}))}}class Dispatcher{constructor(){this.events={}}dispatch(e,t){const o=this.events[e];o&&o.emit(t)}addEventListener(e,t){let o=this.events[e];o||(o=new Event(e),this.events[e]=o),o.registerCallback(t)}removeEventListener(e,t){const o=this.events[e];o&&o.callbacks.indexOf(t)>-1&&(o.unregisterCallback(t),0===o.callbacks.length&&delete this.events[e])}}class Logger{constructor(){if(Logger.instance)return Logger.instance;Logger.instance=this,this.log=[],this.rawLog="",this.dispatcher=new Dispatcher}addEventListener(e,t){if(!(this.dispatcher&&e&&t))throw new Error("Error adding event listener to Logger");this.dispatcher.addEventListener(e,t)}push(e){this.log.push(e),this.rawLog=this.rawLog+"\n"+e.type+" "+[...e.payload].join(),this.dispatcher.dispatch("onLog")}takeOverConsole(){if(window.console){let e,t,o,r;window.console.log&&(e=console.log),window.console.info&&(t=console.info),window.console.warn&&(o=console.warn),window.console.error&&(r=console.error),e&&t&&o&&r&&(o("taking over MAIN console"),console.log=function(t){this.push({func:"logs",payload:[...arguments],type:"[MAIN]"}),e.apply(this,arguments)}.bind(this),console.info=function(e){this.push({func:"logs",payload:[...arguments],type:"[MAIN]"}),t.apply(this,arguments)}.bind(this),console.warn=function(e){this.push({func:"logs",payload:[...arguments],type:"[MAIN]"}),o.apply(this,arguments)}.bind(this),console.error=function(e){this.push({func:"logs",payload:[...arguments],type:"[MAIN]"}),r.apply(this,arguments)}.bind(this),r("MAIN console taken over"))}}}class Engine{constructor(){if(Engine.instance)return Engine.instance;Engine.instance=this,this.origin="",this.learners={},this.analysers={},this.mediaStreamSource={},this.mediaStream={},this.sharedArrayBuffers={},this.dispatcher=new Dispatcher,this.logger=new Logger,this.samplesLoaded=!1,this.isHushed=!1}async addLearner(e,t){if(!t)throw new Error("Error adding Learner instance to Engine");try{await t.init(this.origin),this.addEventListener("onSharedBuffer",(e=>t.addSharedBuffer(e))),t.addEventListener("onSharedBuffer",(e=>this.addSharedBuffer(e))),this.learners[e]=t}catch(e){console.error("Error adding Learner to Engine: ",e)}}removeLearner(e){if(!e)throw new Error("Error with learner ID when removing Learner from Engine");if(this.learners&&e in this.learners){let t=this.learners[e];t.removeEventListener("onSharedBuffer",(e=>this.addSharedBuffer(e))),t=null,delete this.learners[e]}}addEventListener(e,t){if(!(this.dispatcher&&e&&t))throw new Error("Error adding event listener to Engine");this.dispatcher.addEventListener(e,t)}createSharedBuffer(e,t,o){let r=RingBuffer.getStorageForCapacity(32*o,Float64Array),n=new RingBuffer(r,Float64Array);return this.audioWorkletNode.port.postMessage({func:"sab",value:r,ttype:t,channelID:e,blocksize:o}),this.sharedArrayBuffers[e]={sab:r,rb:n},r}addSharedBuffer(e){if(!e)throw new Error("Error with onSharedBuffer event");if(e.value&&e.value instanceof SharedArrayBuffer)try{let t=new RingBuffer(e.value,Float64Array);this.audioWorkletNode.port.postMessage({func:"sab",value:e.value,ttype:e.ttype,channelID:e.channelID,blocksize:e.blocksize}),this.sharedArrayBuffers[e.channelID]={sab:e.value,rb:t}}catch(e){console.error("Error pushing SharedBuffer to engine")}else e.name&&e.data&&this.audioWorkletNode.port.postMessage({func:"sendbuf",name:e.name,data:e.data})}pushDataToSharedBuffer(e,t){if(!(e&&t&&(Array.isArray(t),1)))throw new Error("Error in function parameters");this.sharedArrayBuffers&&this.sharedArrayBuffers[e]&&this.sharedArrayBuffers[e].rb.push(t)}pollAnalyserData(e){if(void 0!==e){const t=new Uint8Array(e.fftSize),o=new Uint8Array(e.fftSize);return e.getByteTimeDomainData(t),e.getByteFrequencyData(o),{smoothingTimeConstant:e.smoothingTimeConstant,fftSize:e.fftSize,frequencyDataArray:o,timeDataArray:t}}}createAnalyser(e,t){if(!e||!t)throw new Error("Parameters to createAnalyser incorrect");if(this.audioContext&&this.audioWorkletNode){let o=this.audioContext.createAnalyser();o.smoothingTimeConstant=.25,o.fftSize=256,o.minDecibels=-90,o.maxDecibels=-0,this.audioWorkletNode.connect(o);let r=-1,n={};this.analysers[e]={analyser:o,analyserFrameId:r,callback:t};const s=()=>(n=this.pollAnalyserData(this.analysers[e].analyser),this.analysers[e].callback(n),this.analysers[e].analyserFrameId=requestAnimationFrame(s),r);console.info("Created analyser"),s()}else this.analysers[e]={callback:t}}connectAnalysers(){Object.keys(this.analysers).map((e=>this.createAnalyser(e,this.analysers[e].callback)))}removeAnalyser(e){if(this.audioContext&&this.audioWorkletNode){void 0!==this.analysers[e.id]&&(cancelAnimationFrame(this.analysers[e.id].analyserFrameId),delete this.analysers[e.id])}}async init(e){if(e&&new URL(e)){let t;try{this.audioContext,this.origin=e,this.audioWorkletName="maxi-processor",this.audioWorkletUrl=e+"/"+this.audioWorkletName+".js",void 0===this.audioContext&&(this.audioContext=new AudioContext({latencyHint:"playback"})),t=await this.loadWorkletProcessorCode(),console.log("Processor loaded")}catch(e){return!1}return!!t&&(this.connectWorkletNode(),!0)}throw new Error("Name and valid URL required for AudioWorklet processor")}play(){if(void 0!==this.audioContext)return"suspended"===this.audioContext.state?(this.audioContext.resume(),!0):(this.hush(),!1)}stop(){void 0!==this.audioWorkletNode&&this.hush()}stopAndRelease(){void 0!==this.audioWorkletNode&&(this.audioWorkletNode.disconnect(this.audioContext.destination),this.audioWorkletNode=void 0)}setGain(e){if(void 0!==this.audioWorkletNode&&e>=0&&e<=1){const t=this.audioWorkletNode.parameters.get("gain");return t.value=e,console.log(t.value),!0}return!1}more(){if(void 0!==this.audioWorkletNode){const e=this.audioWorkletNode.parameters.get("gain");return e.value+=.05,console.info(e.value),e.value}throw new Error("error increasing sound level")}less(){if(void 0!==this.audioWorkletNode){const e=this.audioWorkletNode.parameters.get("gain");return e.value-=.05,console.info(e.value),e.value}throw new Error("error decreasing sound level")}hush(){return void 0!==this.audioWorkletNode&&(this.audioWorkletNode.port.postMessage({hush:1}),this.isHushed=!0,!0)}unHush(){return void 0!==this.audioWorkletNode&&(this.audioWorkletNode.port.postMessage({unhush:1}),this.isHushed=!1,!0)}eval(e){return!(!this.audioWorkletNode||!this.audioWorkletNode.port)&&("suspended"===this.audioContext.state&&this.audioContext.resume(),this.audioWorkletNode.port.postMessage({eval:1,setup:e.setup,loop:e.loop}),this.isHushed=!1,!0)}asyncPostToProcessor(e){if(!(e&&this.audioWorkletNode&&this.audioWorkletNode.port))throw new Error("Error async posting to processor");console.log("DEBUG:AudioEngine:onMessagingEventHandler:"),console.log(e),this.audioWorkletNode.port.postMessage(e)}sendClockPhase(e,t){void 0!==this.audioWorkletNode&&this.audioWorkletNode.port.postMessage({phase:e,i:t})}onAudioInputInit(e){try{this.mediaStreamSource=this.audioContext.createMediaStreamSource(e),this.mediaStreamSource.connect(this.audioWorkletNode),this.mediaStream=e,this.mediaStreamSourceConnected=!0}catch(e){console.error(e)}}onAudioInputFail(e){this.mediaStreamSourceConnected=!1,console.error(`ERROR:Engine:AudioInputFail: ${e.message} ${e.name}`)}onAudioInputDisconnect(){}async connectMediaStream(){const e=window.constraints={audio:{latency:.02,echoCancellation:!1,mozNoiseSuppression:!1,mozAutoGainControl:!1},video:!1};return await navigator.mediaDevices.getUserMedia(e).then((e=>this.onAudioInputInit(e))).catch(this.onAudioInputFail),this.mediaStreamSourceConnected}async disconnectMediaStream(){try{this.mediaStreamSource.disconnect(this.audioWorkletNode),this.mediaStream.getAudioTracks().forEach((e=>e.stop())),this.mediaStreamSource=null,this.mediaStreamSourceConnected=!1}catch(e){console.error(e)}finally{return this.mediaStreamSourceConnected}}async loadWorkletProcessorCode(){if(void 0===this.audioContext)return!1;try{await this.audioContext.audioWorklet.addModule(this.audioWorkletUrl).then(console.info("running %csema-engine v0.1.0","font-weight: bold; color: #ffb7c5"))}catch(e){return console.error("ERROR:Engine:loadWorkletProcessorCode: AudioWorklet not supported in this browser: ",e.message),!1}try{return this.audioWorkletNode=new AudioWorkletNode(this.audioContext,this.audioWorkletName),this.audioWorkletNode.channelInterpretation="discrete",this.audioWorkletNode.channelCountMode="explicit",this.audioWorkletNode.channelCount=this.audioContext.destination.maxChannelCount,!0}catch(e){return console.error("Error loading worklet processor code: ",e),!1}}connectWorkletNode(){if(void 0!==this.audioWorkletNode)try{this.audioContext.destination.channelInterpretation="discrete",this.audioContext.destination.channelCountMode="explicit",this.audioContext.destination.channelCount=this.audioContext.destination.maxChannelCount,this.audioWorkletNode.connect(this.audioContext.destination),this.audioWorkletNode.onprocessorerror=e=>console.error("Engine processor error detected",e),this.audioWorkletNode.onprocessorstatechange=e=>console.info("Engine processor state change: "+audioWorkletNode.processorState),this.audioWorkletNode.port.onmessageerror=e=>console.error("Engine processor port error: "+e),this.audioWorkletNode.port.onmessage=e=>this.onProcessorMessageHandler(e)}catch(e){console.error("Error connecting WorkletNode: ",e)}}onProcessorMessageHandler(e){if(e&&e.data)if("logs"===e.data.func)this.logger.push(e.data);else if(e.data.rq&&"send"===e.data.rq)switch(e.data.ttype){case"ML":break;case"NET":this.peerNet.send(e.data.ch[0],e.data.value,e.data.ch[1])}else if(e.data.rq&&"buf"===e.data.rq)switch(e.data.ttype){case"ML":this.dispatcher.dispatch("onSharedBuffer",{sab:e.data.value,channelID:e.data.channelID,blocksize:e.data.blocksize});break;case"scope":let t=new RingBuffer(e.data.value,Float64Array);this.sharedArrayBuffers[e.data.channelID]={sab:e.data.value,rb:t,ttype:e.data.ttype,channelID:e.data.channelID,blocksize:e.data.blocksize}}else e.data.rq&&"rts"===e.data.rq?(this.audioContext.suspend(),this.isHushed=!0):e.data instanceof Error&&console.error(`On Processor Message ${e.data}`)}subscribeProcessorMessage(e){if(!e||!this.audioWorkletNode)throw new Error("Error subscribing processor message");this.audioWorkletNode.port.onmessage=e}loadSample(e,t){if(!this.audioContext||!this.audioWorkletNode)throw"Engine is not initialised!";if(!(t&&0!==t.length&&this.origin&&0!==this.origin.length&&new URL(this.origin+t)))throw"Problem with sample relative URL";try{loadSampleToArray(this.audioContext,e,this.origin+t,this.audioWorkletNode)}catch(o){console.error(`Error loading sample ${e} from ${t}: `,o)}}}var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(e){var t={exports:{}};return e(t,t.exports),t.exports}var nearley=createCommonjsModule((function(e){var t,o;t=commonjsGlobal,o=function(){function e(t,o,r){return this.id=++e.highestId,this.name=t,this.symbols=o,this.postprocess=r,this}function t(e,t,o,r){this.rule=e,this.dot=t,this.reference=o,this.data=[],this.wantedBy=r,this.isComplete=this.dot===e.symbols.length}function o(e,t){this.grammar=e,this.index=t,this.states=[],this.wants={},this.scannable=[],this.completed={}}function r(e,t){this.rules=e,this.start=t||this.rules[0].name;var o=this.byName={};this.rules.forEach((function(e){o.hasOwnProperty(e.name)||(o[e.name]=[]),o[e.name].push(e)}))}function n(){this.reset("")}function s(e,t,s){if(e instanceof r){var a=e;s=t}else a=r.fromCompiled(e,t);for(var i in this.grammar=a,this.options={keepHistory:!1,lexer:a.lexer||new n},s||{})this.options[i]=s[i];this.lexer=this.options.lexer,this.lexerState=void 0;var l=new o(a,0);this.table=[l],l.wants[a.start]=[],l.predict(a.start),l.process(),this.current=0}function a(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return e.toString();if(e.type)return"%"+e.type;if(e.test)return"<"+String(e.test)+">";throw new Error("Unknown symbol type: "+e)}}return e.highestId=0,e.prototype.toString=function(e){var t=void 0===e?this.symbols.map(a).join(" "):this.symbols.slice(0,e).map(a).join(" ")+" ● "+this.symbols.slice(e).map(a).join(" ");return this.name+" → "+t},t.prototype.toString=function(){return"{"+this.rule.toString(this.dot)+"}, from: "+(this.reference||0)},t.prototype.nextState=function(e){var o=new t(this.rule,this.dot+1,this.reference,this.wantedBy);return o.left=this,o.right=e,o.isComplete&&(o.data=o.build(),o.right=void 0),o},t.prototype.build=function(){var e=[],t=this;do{e.push(t.right.data),t=t.left}while(t.left);return e.reverse(),e},t.prototype.finish=function(){this.rule.postprocess&&(this.data=this.rule.postprocess(this.data,this.reference,s.fail))},o.prototype.process=function(e){for(var t=this.states,o=this.wants,r=this.completed,n=0;n<t.length;n++){var a=t[n];if(a.isComplete){if(a.finish(),a.data!==s.fail){for(var i=a.wantedBy,l=i.length;l--;){var p=i[l];this.complete(p,a)}if(a.reference===this.index){var u=a.rule.name;(this.completed[u]=this.completed[u]||[]).push(a)}}}else{if("string"!=typeof(u=a.rule.symbols[a.dot])){this.scannable.push(a);continue}if(o[u]){if(o[u].push(a),r.hasOwnProperty(u)){var c=r[u];for(l=0;l<c.length;l++){var d=c[l];this.complete(a,d)}}}else o[u]=[a],this.predict(u)}}},o.prototype.predict=function(e){for(var o=this.grammar.byName[e]||[],r=0;r<o.length;r++){var n=o[r],s=this.wants[e],a=new t(n,0,this.index,s);this.states.push(a)}},o.prototype.complete=function(e,t){var o=e.nextState(t);this.states.push(o)},r.fromCompiled=function(t,o){var n=t.Lexer;t.ParserStart&&(o=t.ParserStart,t=t.ParserRules);var s=new r(t=t.map((function(t){return new e(t.name,t.symbols,t.postprocess)})),o);return s.lexer=n,s},n.prototype.reset=function(e,t){this.buffer=e,this.index=0,this.line=t?t.line:1,this.lastLineBreak=t?-t.col:0},n.prototype.next=function(){if(this.index<this.buffer.length){var e=this.buffer[this.index++];return"\n"===e&&(this.line+=1,this.lastLineBreak=this.index),{value:e}}},n.prototype.save=function(){return{line:this.line,col:this.index-this.lastLineBreak}},n.prototype.formatError=function(e,t){var o=this.buffer;if("string"==typeof o){var r=o.split("\n").slice(Math.max(0,this.line-5),this.line);o.indexOf("\n",this.index);var n=this.index-this.lastLineBreak,s=String(this.line).length;return t+=" at line "+this.line+" col "+n+":\n\n",t+=r.map((function(e,t){return a(this.line-r.length+t+1,s)+" "+e}),this).join("\n"),t+="\n"+a("",s+n)+"^\n"}return t+" at index "+(this.index-1);function a(e,t){var o=String(e);return Array(t-o.length+1).join(" ")+o}},s.fail={},s.prototype.feed=function(e){var t,r=this.lexer;for(r.reset(e,this.lexerState);;){try{if(!(t=r.next()))break}catch(e){var s=new o(this.grammar,this.current+1);throw this.table.push(s),(l=new Error(this.reportLexerError(e))).offset=this.current,l.token=e.token,l}var a=this.table[this.current];this.options.keepHistory||delete this.table[this.current-1];var i=this.current+1;s=new o(this.grammar,i),this.table.push(s);for(var l,p=void 0!==t.text?t.text:t.value,u=r.constructor===n?t.value:t,c=a.scannable,d=c.length;d--;){var h=c[d],m=h.rule.symbols[h.dot];if(m.test?m.test(u):m.type?m.type===t.type:m.literal===p){var f=h.nextState({data:u,token:t,isToken:!0,reference:i-1});s.states.push(f)}}if(s.process(),0===s.states.length)throw(l=new Error(this.reportError(t))).offset=this.current,l.token=t,l;this.options.keepHistory&&(a.lexerState=r.save()),this.current++}return a&&(this.lexerState=r.save()),this.results=this.finish(),this},s.prototype.reportLexerError=function(e){var t,o,r=e.token;return r?(t="input "+JSON.stringify(r.text[0])+" (lexer error)",o=this.lexer.formatError(r,"Syntax error")):(t="input (lexer error)",o=e.message),this.reportErrorCommon(o,t)},s.prototype.reportError=function(e){var t=(e.type?e.type+" token: ":"")+JSON.stringify(void 0!==e.value?e.value:e),o=this.lexer.formatError(e,"Syntax error");return this.reportErrorCommon(o,t)},s.prototype.reportErrorCommon=function(e,t){var o=[];o.push(e);var r=this.table.length-2,n=this.table[r],s=n.states.filter((function(e){var t=e.rule.symbols[e.dot];return t&&"string"!=typeof t}));return 0===s.length?(o.push("Unexpected "+t+". I did not expect any more input. Here is the state of my parse table:\n"),this.displayStateStack(n.states,o)):(o.push("Unexpected "+t+". Instead, I was expecting to see one of the following:\n"),s.map((function(e){return this.buildFirstStateStack(e,[])||[e]}),this).forEach((function(e){var t=e[0],r=t.rule.symbols[t.dot],n=this.getSymbolDisplay(r);o.push("A "+n+" based on:"),this.displayStateStack(e,o)}),this)),o.push(""),o.join("\n")},s.prototype.displayStateStack=function(e,t){for(var o,r=0,n=0;n<e.length;n++){var s=e[n],a=s.rule.toString(s.dot);a===o?r++:(r>0&&t.push("    ^ "+r+" more lines identical to this"),r=0,t.push("    "+a)),o=a}},s.prototype.getSymbolDisplay=function(e){return function(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return"character matching "+e;if(e.type)return e.type+" token";if(e.test)return"token matching "+String(e.test);throw new Error("Unknown symbol type: "+e)}}(e)},s.prototype.buildFirstStateStack=function(e,t){if(-1!==t.indexOf(e))return null;if(0===e.wantedBy.length)return[e];var o=e.wantedBy[0],r=[e].concat(t),n=this.buildFirstStateStack(o,r);return null===n?null:[e].concat(n)},s.prototype.save=function(){var e=this.table[this.current];return e.lexerState=this.lexerState,e},s.prototype.restore=function(e){var t=e.index;this.current=t,this.table[t]=e,this.table.splice(t+1),this.lexerState=e.lexerState,this.results=this.finish()},s.prototype.rewind=function(e){if(!this.options.keepHistory)throw new Error("set option `keepHistory` to enable rewinding");this.restore(this.table[e])},s.prototype.finish=function(){var e=[],t=this.grammar.start;return this.table[this.table.length-1].states.forEach((function(o){o.rule.name===t&&o.dot===o.rule.symbols.length&&0===o.reference&&o.data!==s.fail&&e.push(o)})),e.map((function(e){return e.data}))},{Parser:s,Grammar:r,Rule:e}},e.exports?e.exports=o():t.nearley=o()})),moo=createCommonjsModule((function(e){var t,o;t=commonjsGlobal,o=function(){var e=Object.prototype.hasOwnProperty,t=Object.prototype.toString,o="boolean"==typeof(new RegExp).sticky;function r(e){return e&&"[object RegExp]"===t.call(e)}function n(e){return e&&"object"==typeof e&&!r(e)&&!Array.isArray(e)}function s(e){return"("+e+")"}function a(e){return e.length?"(?:"+e.map((function(e){return"(?:"+e+")"})).join("|")+")":"(?!)"}function i(e){if("string"==typeof e)return"(?:"+e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")";if(r(e)){if(e.ignoreCase)throw new Error("RegExp /i flag not allowed");if(e.global)throw new Error("RegExp /g flag is implied");if(e.sticky)throw new Error("RegExp /y flag is implied");if(e.multiline)throw new Error("RegExp /m flag is implied");return e.source}throw new Error("Not a pattern: "+e)}function l(t,o){if(n(o)||(o={match:o}),o.include)throw new Error("Matching rules cannot also include states");var s={defaultType:t,lineBreaks:!!o.error||!!o.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var a in o)e.call(o,a)&&(s[a]=o[a]);if("string"==typeof s.type&&t!==s.type)throw new Error("Type transform cannot be a string (type '"+s.type+"' for token '"+t+"')");var i=s.match;return s.match=Array.isArray(i)?i:i?[i]:[],s.match.sort((function(e,t){return r(e)&&r(t)?0:r(t)?-1:r(e)?1:t.length-e.length})),s}function p(e){return Array.isArray(e)?function(e){for(var t=[],o=0;o<e.length;o++){var r=e[o];if(r.include)for(var n=[].concat(r.include),s=0;s<n.length;s++)t.push({include:n[s]});else{if(!r.type)throw new Error("Rule has no type: "+JSON.stringify(r));t.push(l(r.type,r))}}return t}(e):function(e){for(var t=Object.getOwnPropertyNames(e),o=[],r=0;r<t.length;r++){var s=t[r],a=e[s],i=[].concat(a);if("include"!==s){var p=[];i.forEach((function(e){n(e)?(p.length&&o.push(l(s,p)),o.push(l(s,e)),p=[]):p.push(e)})),p.length&&o.push(l(s,p))}else for(var u=0;u<i.length;u++)o.push({include:i[u]})}return o}(e)}var u=l("error",{lineBreaks:!0,shouldThrow:!0});function c(e,t){for(var n=null,l=Object.create(null),p=!0,c=null,d=[],h=[],m=0;m<e.length;m++)e[m].fallback&&(p=!1);for(m=0;m<e.length;m++){var f=e[m];if(f.include)throw new Error("Inheritance is not allowed in stateless lexers");if(f.error||f.fallback){if(n)throw!f.fallback==!n.fallback?new Error("Multiple "+(f.fallback?"fallback":"error")+" rules not allowed (for token '"+f.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+f.defaultType+"')");n=f}var g=f.match.slice();if(p)for(;g.length&&"string"==typeof g[0]&&1===g[0].length;)l[g.shift().charCodeAt(0)]=f;if(f.pop||f.push||f.next){if(!t)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+f.defaultType+"')");if(f.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+f.defaultType+"')")}if(0!==g.length){p=!1,d.push(f);for(var y=0;y<g.length;y++){var b=g[y];if(r(b))if(null===c)c=b.unicode;else if(c!==b.unicode&&!1===f.fallback)throw new Error("If one rule is /u then all must be")}var v=a(g.map(i)),$=new RegExp(v);if($.test(""))throw new Error("RegExp matches empty string: "+$);if(new RegExp("|"+v).exec("").length-1>0)throw new Error("RegExp has capture groups: "+$+"\nUse (?: … ) instead");if(!f.lineBreaks&&$.test("\n"))throw new Error("Rule should declare lineBreaks: "+$);h.push(s(v))}}var x=n&&n.fallback,w=o&&!x?"ym":"gm",S=o||x?"":"|";return!0===c&&(w+="u"),{regexp:new RegExp(a(h)+S,w),groups:d,fast:l,error:n||u}}function d(e,t,o){var r=e&&(e.push||e.next);if(r&&!o[r])throw new Error("Missing state '"+r+"' (in token '"+e.defaultType+"' of state '"+t+"')");if(e&&e.pop&&1!=+e.pop)throw new Error("pop must be 1 (in token '"+e.defaultType+"' of state '"+t+"')")}var h=function(e,t){this.startState=t,this.states=e,this.buffer="",this.stack=[],this.reset()};h.prototype.reset=function(e,t){return this.buffer=e||"",this.index=0,this.line=t?t.line:1,this.col=t?t.col:1,this.queuedToken=t?t.queuedToken:null,this.queuedThrow=t?t.queuedThrow:null,this.setState(t?t.state:this.startState),this.stack=t&&t.stack?t.stack.slice():[],this},h.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedThrow:this.queuedThrow}},h.prototype.setState=function(e){if(e&&this.state!==e){this.state=e;var t=this.states[e];this.groups=t.groups,this.error=t.error,this.re=t.regexp,this.fast=t.fast}},h.prototype.popState=function(){this.setState(this.stack.pop())},h.prototype.pushState=function(e){this.stack.push(this.state),this.setState(e)};var m=o?function(e,t){return e.exec(t)}:function(e,t){var o=e.exec(t);return 0===o[0].length?null:o};function f(){return this.value}if(h.prototype._getGroup=function(e){for(var t=this.groups.length,o=0;o<t;o++)if(void 0!==e[o+1])return this.groups[o];throw new Error("Cannot find token type for matched text")},h.prototype.next=function(){var e=this.index;if(this.queuedGroup){var t=this._token(this.queuedGroup,this.queuedText,e);return this.queuedGroup=null,this.queuedText="",t}var o=this.buffer;if(e!==o.length){if(a=this.fast[o.charCodeAt(e)])return this._token(a,o.charAt(e),e);var r=this.re;r.lastIndex=e;var n=m(r,o),s=this.error;if(null==n)return this._token(s,o.slice(e,o.length),e);var a=this._getGroup(n),i=n[0];return s.fallback&&n.index!==e?(this.queuedGroup=a,this.queuedText=i,this._token(s,o.slice(e,n.index),e)):this._token(a,i,e)}},h.prototype._token=function(e,t,o){var r=0;if(e.lineBreaks){var n=/\n/g,s=1;if("\n"===t)r=1;else for(;n.exec(t);)r++,s=n.lastIndex}var a={type:"function"==typeof e.type&&e.type(t)||e.defaultType,value:"function"==typeof e.value?e.value(t):t,text:t,toString:f,offset:o,lineBreaks:r,line:this.line,col:this.col},i=t.length;if(this.index+=i,this.line+=r,0!==r?this.col=i-s+1:this.col+=i,e.shouldThrow)throw new Error(this.formatError(a,"invalid syntax"));return e.pop?this.popState():e.push?this.pushState(e.push):e.next&&this.setState(e.next),a},"undefined"!=typeof Symbol&&Symbol.iterator){var g=function(e){this.lexer=e};g.prototype.next=function(){var e=this.lexer.next();return{value:e,done:!e}},g.prototype[Symbol.iterator]=function(){return this},h.prototype[Symbol.iterator]=function(){return new g(this)}}return h.prototype.formatError=function(e,t){if(null==e){var o=this.buffer.slice(this.index);e={text:o,offset:this.index,lineBreaks:-1===o.indexOf("\n")?0:1,line:this.line,col:this.col}}var r=Math.max(0,e.offset-e.col+1),n=e.lineBreaks?e.text.indexOf("\n"):e.text.length,s=this.buffer.substring(r,e.offset+n);return t+=" at line "+e.line+" col "+e.col+":\n\n",t+="  "+s+"\n",t+="  "+Array(e.col).join(" ")+"^"},h.prototype.clone=function(){return new h(this.states,this.state)},h.prototype.has=function(e){return!0},{compile:function(e){var t=c(p(e));return new h({start:t},"start")},states:function(e,t){var o=e.$all?p(e.$all):[];delete e.$all;var r=Object.getOwnPropertyNames(e);t||(t=r[0]);for(var n=Object.create(null),s=0;s<r.length;s++)n[v=r[s]]=p(e[v]).concat(o);for(s=0;s<r.length;s++)for(var a=n[v=r[s]],i=Object.create(null),l=0;l<a.length;l++){var u=a[l];if(u.include){var m=[l,1];if(u.include!==v&&!i[u.include]){i[u.include]=!0;var f=n[u.include];if(!f)throw new Error("Cannot include nonexistent state '"+u.include+"' (in state '"+v+"')");for(var g=0;g<f.length;g++){var y=f[g];-1===a.indexOf(y)&&m.push(y)}}a.splice.apply(a,m),l--}}var b=Object.create(null);for(s=0;s<r.length;s++){var v;b[v=r[s]]=c(n[v],!0)}for(s=0;s<r.length;s++){var $=r[s],x=b[$],w=x.groups;for(l=0;l<w.length;l++)d(w[l],$,b);var S=Object.getOwnPropertyNames(x.fast);for(l=0;l<S.length;l++)d(x.fast[S[l]],$,b)}return new h(b,t)},error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:function(e){for(var t=Object.create(null),o=Object.create(null),r=Object.getOwnPropertyNames(e),n=0;n<r.length;n++){var s=r[n],a=e[s];(Array.isArray(a)?a:[a]).forEach((function(e){if((o[e.length]=o[e.length]||[]).push(e),"string"!=typeof e)throw new Error("keyword must be string (in keyword '"+s+"')");t[e]=s}))}function i(e){return JSON.stringify(e)}var l="";for(var p in l+="switch (value.length) {\n",o){var u=o[p];l+="case "+p+":\n",l+="switch (value) {\n",u.forEach((function(e){var o=t[e];l+="case "+i(e)+": return "+i(o)+"\n"})),l+="}\n"}return l+="}\n",Function("value",l)}}},e.exports?e.exports=o():t.moo=o()})),nearleyLanguageBootstrapped=createCommonjsModule((function(e){!function(){function t(e){return e[0]}function o(e){return e[0].value}var r=moo,n=Object.assign({ws:{match:/\s+/,lineBreaks:!0,next:"main"},comment:/\#.*/,arrow:{match:/[=-]+\>/,next:"main"},js:{match:/\{\%(?:[^%]|\%[^}])*\%\}/,value:e=>e.slice(2,-2),lineBreaks:!0},word:{match:/[\w\?\+]+/,next:"afterWord"},string:{match:/"(?:[^\\"\n]|\\["\\/bfnrt]|\\u[a-fA-F0-9]{4})*"/,value:e=>JSON.parse(e),next:"main"},btstring:{match:/`[^`]*`/,value:e=>e.slice(1,-1),next:"main",lineBreaks:!0}},function(e){var t={};for(var o of e)t[o]={match:o,next:"main"};return t}([",","|","$","%","(",")",":?",":*",":+","@include","@builtin","@","]"])),s=r.states({main:Object.assign({},n,{charclass:{match:/\.|\[(?:\\.|[^\\\n])+?\]/,value:e=>new RegExp(e)}}),afterWord:Object.assign({},n,{"[":{match:"[",next:"main"}})});var a={Lexer:s,ParserRules:[{name:"final$ebnf$1",symbols:[s.has("ws")?{type:"ws"}:ws],postprocess:t},{name:"final$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"final",symbols:["_","prog","_","final$ebnf$1"],postprocess:function(e){return e[1]}},{name:"prog",symbols:["prod"],postprocess:function(e){return[e[0]]}},{name:"prog",symbols:["prod","ws","prog"],postprocess:function(e){return[e[0]].concat(e[2])}},{name:"prod",symbols:["word","_",s.has("arrow")?{type:"arrow"}:arrow,"_","expression+"],postprocess:function(e){return{name:e[0],rules:e[4]}}},{name:"prod",symbols:["word",{literal:"["},"_","wordlist","_",{literal:"]"},"_",s.has("arrow")?{type:"arrow"}:arrow,"_","expression+"],postprocess:function(e){return{macro:e[0],args:e[3],exprs:e[9]}}},{name:"prod",symbols:[{literal:"@"},"_","js"],postprocess:function(e){return{body:e[2]}}},{name:"prod",symbols:[{literal:"@"},"word","ws","word"],postprocess:function(e){return{config:e[1],value:e[3]}}},{name:"prod",symbols:[{literal:"@include"},"_","string"],postprocess:function(e){return{include:e[2].literal,builtin:!1}}},{name:"prod",symbols:[{literal:"@builtin"},"_","string"],postprocess:function(e){return{include:e[2].literal,builtin:!0}}},{name:"expression+",symbols:["completeexpression"]},{name:"expression+",symbols:["expression+","_",{literal:"|"},"_","completeexpression"],postprocess:function(e){return e[0].concat([e[4]])}},{name:"expressionlist",symbols:["completeexpression"]},{name:"expressionlist",symbols:["expressionlist","_",{literal:","},"_","completeexpression"],postprocess:function(e){return e[0].concat([e[4]])}},{name:"wordlist",symbols:["word"]},{name:"wordlist",symbols:["wordlist","_",{literal:","},"_","word"],postprocess:function(e){return e[0].concat([e[4]])}},{name:"completeexpression",symbols:["expr"],postprocess:function(e){return{tokens:e[0]}}},{name:"completeexpression",symbols:["expr","_","js"],postprocess:function(e){return{tokens:e[0],postprocess:e[2]}}},{name:"expr_member",symbols:["word"],postprocess:t},{name:"expr_member",symbols:[{literal:"$"},"word"],postprocess:function(e){return{mixin:e[1]}}},{name:"expr_member",symbols:["word",{literal:"["},"_","expressionlist","_",{literal:"]"}],postprocess:function(e){return{macrocall:e[0],args:e[3]}}},{name:"expr_member$ebnf$1",symbols:[{literal:"i"}],postprocess:t},{name:"expr_member$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"expr_member",symbols:["string","expr_member$ebnf$1"],postprocess:function(e){return e[1]?function(e){for(var t=e.literal,o=[],r=0;r<t.length;r++){var n=t.charAt(r);n.toUpperCase()!==n||n.toLowerCase()!==n?o.push(new RegExp("["+n.toLowerCase()+n.toUpperCase()+"]")):o.push({literal:n})}return{subexpression:[{tokens:o,postprocess:function(e){return e.join("")}}]}}(e[0]):e[0]}},{name:"expr_member",symbols:[{literal:"%"},"word"],postprocess:function(e){return{token:e[1]}}},{name:"expr_member",symbols:["charclass"],postprocess:t},{name:"expr_member",symbols:[{literal:"("},"_","expression+","_",{literal:")"}],postprocess:function(e){return{subexpression:e[2]}}},{name:"expr_member",symbols:["expr_member","_","ebnf_modifier"],postprocess:function(e){return{ebnf:e[0],modifier:e[2]}}},{name:"ebnf_modifier",symbols:[{literal:":+"}],postprocess:o},{name:"ebnf_modifier",symbols:[{literal:":*"}],postprocess:o},{name:"ebnf_modifier",symbols:[{literal:":?"}],postprocess:o},{name:"expr",symbols:["expr_member"]},{name:"expr",symbols:["expr","ws","expr_member"],postprocess:function(e){return e[0].concat([e[2]])}},{name:"word",symbols:[s.has("word")?{type:"word"}:word],postprocess:o},{name:"string",symbols:[s.has("string")?{type:"string"}:string],postprocess:e=>({literal:e[0].value})},{name:"string",symbols:[s.has("btstring")?{type:"btstring"}:btstring],postprocess:e=>({literal:e[0].value})},{name:"charclass",symbols:[s.has("charclass")?{type:"charclass"}:charclass],postprocess:o},{name:"js",symbols:[s.has("js")?{type:"js"}:js],postprocess:o},{name:"_$ebnf$1",symbols:["ws"],postprocess:t},{name:"_$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"_",symbols:["_$ebnf$1"]},{name:"ws",symbols:[s.has("ws")?{type:"ws"}:ws]},{name:"ws$ebnf$1",symbols:[s.has("ws")?{type:"ws"}:ws],postprocess:t},{name:"ws$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"ws",symbols:["ws$ebnf$1",s.has("comment")?{type:"comment"}:comment,"_"]}],ParserStart:"final"};e.exports=a}()}));function compileLowLevel(e,t){var o=uniquer();t.alreadycompiled||(t.alreadycompiled=[]);for(var r={rules:[],body:[],config:{},customTokens:[],macros:{},start:""},n=0;n<e.length;n++){var s=e[n];if(c(s.name,s.pos,s.name&&s.name.length),s.body)t.nojs||r.body.push(s.body);else if(s.include){var a;if(a=s.builtin?s.include:require("path").resolve(t.file?require("path").dirname(t.file):process.cwd(),s.include),-1===t.alreadycompiled.indexOf(a)){if(t.alreadycompiled.push(a),"postprocessors.ne"===a)var i=require("nearley/builtin/postprocessors.ne");else if("whitespace.ne"===a)i=require("nearley/builtin/whitespace.ne");else if("string.ne"===a)i=require("nearley/builtin/string.ne");else if("number.ne"===a)i=require("nearley/builtin/number.ne");else if("cow.ne"===a)i=require("nearley/builtin/cow.ne");var l=nearley.Grammar.fromCompiled(nearleyLanguageBootstrapped),p=new nearley.Parser(l);p.feed(i);var u=Compile(p.results[0],{file:a,__proto__:t});r.rules=r.rules.concat(u.rules),r.body=r.body.concat(u.body),Object.keys(u.config).forEach((function(e){r.config[e]=u.config[e]})),Object.keys(u.macros).forEach((function(e){r.macros[e]=u.macros[e]}))}}else s.macro?r.macros[s.macro]={args:s.args,exprs:s.exprs}:s.config?r.config[s.config]=s.value:(d(s.name,s.rules,{}),r.start||(r.start=s.name))}return r;function c(e,o,r){t.rangeCallback&&t.rangeCallback(e,o,o+r)}function d(e,o,n){for(var s=0;s<o.length;s++){var a=h(e,o[s],n);t.nojs&&(a.postprocess=null),r.rules.push(a)}}function h(e,t,o){for(var r=[],n=0;n<t.tokens.length;n++){var s=m(e,t.tokens[n],o);null!==s&&r.push(s)}return new nearley.Rule(e,r,t.postprocess)}function m(e,t,n){if("string"==typeof t)return"null"===t?null:t;if(t instanceof RegExp)return t;if(t.literal)return t.literal.length?1===t.literal.length||r.config.lexer?t:function(e,t,r){var n=o(e+"$string");return c(n,t.pos,JSON.stringify(t.literal).length),d(n,[{tokens:t.literal.split("").map((function(e){return{literal:e}})),postprocess:{builtin:"joiner"}}],r),n}(e,t,n):null;if(t.token){if(r.config.lexer){var s=t.token;return-1===r.customTokens.indexOf(s)&&r.customTokens.push(s),{token:"("+(r.config.lexer+".has("+JSON.stringify(s)+") ? {type: "+JSON.stringify(s)+"} : "+s)+")"}}return t}if(t.subexpression)return function(e,t,r){var n=t.subexpression,s=o(e+"$subexpression");return d(s,n,r),s}(e,t,n);if(t.ebnf)return function(e,t,r){switch(t.modifier){case":+":return function(e,t,r){var n=o(e+"$ebnf");return d(n,[{tokens:[t.ebnf]},{tokens:[t.ebnf,n],postprocess:{builtin:"arrconcat"}}],r),n}(e,t,r);case":*":return function(e,t,r){var n=o(e+"$ebnf");return d(n,[{tokens:[]},{tokens:[t.ebnf,n],postprocess:{builtin:"arrconcat"}}],r),n}(e,t,r);case":?":return function(e,t,r){var n=o(e+"$ebnf");return d(n,[{tokens:[t.ebnf],postprocess:{builtin:"id"}},{tokens:[],postprocess:{builtin:"nuller"}}],r),n}(e,t,r)}}(e,t,n);if(t.macrocall)return function(e,t,n){var s=o(e+"$macrocall"),a=r.macros[t.macrocall];if(!a)throw new Error("Unkown macro: "+t.macrocall);if(a.args.length!==t.args.length)throw new Error("Argument count mismatch.");for(var i={__proto__:n},l=0;l<a.args.length;l++){var p=o(e+"$macrocall");i[a.args[l]]=p,d(p,[t.args[l]],n)}return d(s,a.exprs,i),s}(e,t,n);if(t.mixin){if(n[t.mixin])return m(e,n[t.mixin],n);throw new Error("Unbound variable: "+t.mixin)}throw new Error("unrecognized token: "+JSON.stringify(t))}}function uniquer(){var e={};return function(t){var o=e[t]=(e[t]||0)+1;return t+"$"+o}}var generate=createCommonjsModule((function(e){var t,o;t=commonjsGlobal,o=function(e){function t(e,t,s){return null==s&&(s=""),"[\n    "+e.map((function(e){return function(e,t){var s="{";return s+='"name": '+JSON.stringify(e.name),s+=', "symbols": ['+e.symbols.map(n).join(", ")+"]",e.postprocess&&(e.postprocess.builtin&&(e.postprocess=t[e.postprocess.builtin]),s+=', "postprocess": '+r(o(e.postprocess),"        ",{indentFirst:!1})),s+="}"}(e,t)})).join(",\n    ")+"\n"+s+"]"}function o(e){var t=e.toString().split(/\n/);if(1===t.length)return[t[0].replace(/^\s+|\s+$/g,"")];for(var o=null,r=t.slice(1),n=0;n<r.length;n++){var s=/^\s*/.exec(r[n]);s&&s[0].length!==r[n].length&&(null===o||s[0].length<o.length)&&(o=s[0])}return null===o?t:t.map((function(e){return e.slice(0,o.length)===o?e.slice(o.length):e}))}function r(e,t,o){var r;return r=Array.isArray(e)?e:e.toString().split("\n"),o=o||{},r.map((function(e,r){var n=!0;return 0!=r||o.indentFirst||(n=!1),n?t+e:e})).join("\n")}function n(e){return e instanceof RegExp?e.toString():e.token?e.token:JSON.stringify(e)}var s=function(e,t){if(e.config.preprocessor||(e.config.preprocessor="_default"),!s[e.config.preprocessor])throw new Error("No such preprocessor: "+e.config.preprocessor);return s[e.config.preprocessor](e,t)};return s.js=s._default=s.javascript=function(e,o){var r="// Generated automatically by nearley, version "+e.version+"\n";return r+="// http://github.com/Hardmath123/nearley\n",r+="(function () {\n",r+="function id(x) { return x[0]; }\n",r+=e.body.join("\n"),r+="var grammar = {\n",r+="    Lexer: "+e.config.lexer+",\n",r+="    ParserRules: "+t(e.rules,s.javascript.builtinPostprocessors)+"\n",r+="  , ParserStart: "+JSON.stringify(e.start)+"\n",r+="}\n",r+="if (typeof module !== 'undefined'&& typeof module.exports !== 'undefined') {\n",r+="   module.exports = grammar;\n",r+="} else {\n",r+="   window."+o+" = grammar;\n",r+="}\n",r+="})();\n"},s.javascript.builtinPostprocessors={joiner:"function joiner(d) {return d.join('');}",arrconcat:"function arrconcat(d) {return [d[0]].concat(d[1]);}",arrpush:"function arrpush(d) {return d[0].concat([d[1]]);}",nuller:"function(d) {return null;}",id:"id"},s.module=s.esmodule=function(e,o){var r="// Generated automatically by nearley, version "+e.version+"\n";return r+="// http://github.com/Hardmath123/nearley\n",r+="function id(x) { return x[0]; }\n",r+=e.body.join("\n"),r+="let Lexer = "+e.config.lexer+";\n",r+="let ParserRules = "+t(e.rules,s.javascript.builtinPostprocessors)+";\n",r+="let ParserStart = "+JSON.stringify(e.start)+";\n",r+="export default { Lexer, ParserRules, ParserStart };\n"},s.cs=s.coffee=s.coffeescript=function(e,n){var a="# Generated automatically by nearley, version "+e.version+"\n";return a+="# http://github.com/Hardmath123/nearley\n",a+="do ->\n",a+="  id = (d) -> d[0]\n",a+=r(o(e.body.join("\n")),"  ")+"\n",a+="  grammar = {\n",a+="    Lexer: "+e.config.lexer+",\n",a+="    ParserRules: "+r(t(e.rules,s.coffeescript.builtinPostprocessors),"      ",{indentFirst:!1})+",\n",a+="    ParserStart: "+JSON.stringify(e.start)+"\n",a+="  }\n",a+="  if typeof module != 'undefined' && typeof module.exports != 'undefined'\n",a+="    module.exports = grammar;\n",a+="  else\n",a+="    window."+n+" = grammar;\n"},s.coffeescript.builtinPostprocessors={joiner:"(d) -> d.join('')",arrconcat:"(d) -> [d[0]].concat(d[1])",arrpush:"(d) -> d[0].concat([d[1]])",nuller:"() -> null",id:"id"},s.ts=s.typescript=function(e,o){var r="// Generated automatically by nearley, version "+e.version+"\n";return r+="// http://github.com/Hardmath123/nearley\n",r+="// Bypasses TS6133. Allow declared but unused functions.\n",r+="// @ts-ignore\n",r+="function id(d: any[]): any { return d[0]; }\n",r+=e.customTokens.map((function(e){return"declare var "+e+": any;\n"})).join(""),r+=e.body.join("\n"),r+="\n",r+="interface NearleyToken {\n",r+="  value: any;\n",r+="  [key: string]: any;\n",r+="};\n",r+="\n",r+="interface NearleyLexer {\n",r+="  reset: (chunk: string, info: any) => void;\n",r+="  next: () => NearleyToken | undefined;\n",r+="  save: () => any;\n",r+="  formatError: (token: never) => string;\n",r+="  has: (tokenType: string) => boolean;\n",r+="};\n",r+="\n",r+="interface NearleyRule {\n",r+="  name: string;\n",r+="  symbols: NearleySymbol[];\n",r+="  postprocess?: (d: any[], loc?: number, reject?: {}) => any;\n",r+="};\n",r+="\n",r+="type NearleySymbol = string | { literal: any } | { test: (token: any) => boolean };\n",r+="\n",r+="interface Grammar {\n",r+="  Lexer: NearleyLexer | undefined;\n",r+="  ParserRules: NearleyRule[];\n",r+="  ParserStart: string;\n",r+="};\n",r+="\n",r+="const grammar: Grammar = {\n",r+="  Lexer: "+e.config.lexer+",\n",r+="  ParserRules: "+t(e.rules,s.typescript.builtinPostprocessors,"  ")+",\n",r+="  ParserStart: "+JSON.stringify(e.start)+",\n",r+="};\n",r+="\n",r+="export default grammar;\n"},s.typescript.builtinPostprocessors={joiner:"(d) => d.join('')",arrconcat:"(d) => [d[0]].concat(d[1])",arrpush:"(d) => d[0].concat([d[1]])",nuller:"() => null",id:"id"},s},e.exports?e.exports=o():t.generate=o(t.nearley)})),warn=function(e,t){e.out.write("WARN\t"+t+"\n")};function lintNames(e,t){var o=[];e.rules.forEach((function(e){o.push(e.name)})),e.rules.forEach((function(e){e.symbols.forEach((function(e){e.literal||e.token||e.constructor===RegExp||-1===o.indexOf(e)&&warn(t,"Undefined symbol `"+e+"` used.")}))}))}function lint(e,t){t.out||(t.out=process.stderr),lintNames(e,t)}var lint_1=lint,objectID=0,vars={};function genBlepOsc(e){return{setup:(t,o)=>`${t} = new Maximilian.maxiPolyBLEP();\n\t\t\t\t\t\t\t\t\t\t\t${t}.setWaveform(${e});\n\t\t\t\t\t\t\t\t\t\t\t`,loop:(e,t)=>1==t.length?`${e}.play(${t[0].loop})`:`(()=>{${e}.setPulseWidth(${t[1].loop}); return ${e}.play(${t[0].loop});})()`}}var jsFuncMap={saw:{setup:(e,t)=>`${e} = new Module.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.saw(${t[0].loop})`},sin:{setup:(e,t)=>`${e} = new Module.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.sinewave(${t[0].loop})`},tri:{setup:(e,t)=>`${e} = new Module.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.triangle(${t[0].loop})`},pha:{setup:(e,t)=>`${e} = new Module.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.phasor(${t[0].loop})`},ph2:{setup:(e,t)=>`${e} = new Module.maxiOsc();\n                      ${e}.phaseReset(${t.length>3?t[3].loop:0});`,loop:(e,t)=>`${e}.phasorBetween(${t[0].loop},${t[1].loop},${t[2].loop})`},sqr:{setup:(e,t)=>`${e} = new Module.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.square(${t[0].loop})`},pul:{setup:(e,t)=>`${e} = new Module.maxiOsc();\n                      ${e}.phaseReset(${t.length>2?t[2].loop:0});`,loop:(e,t)=>`${e}.pulse(${t[0].loop},${t[1].loop})`},imp:{setup:(e,t)=>`${e} = new Module.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.impulse(${t[0].loop})`},sawn:{setup:(e,t)=>`${e} = new Module.maxiOsc();\n                      ${e}.phaseReset(${t.length>1?t[1].loop:0});`,loop:(e,t)=>`${e}.sawn(${t[0].loop})`},noiz:{setup:(e,t)=>`${e} = new Module.maxiOsc()`,loop:(e,t)=>`${e}.noise()*${t[0].loop}`},gt:{setup:(e,t)=>"",loop:(e,t)=>`((${t[0].loop} > ${t[1].loop}) ? 1 : 0)`},lt:{setup:(e,t)=>"",loop:(e,t)=>`((${t[0].loop} < ${t[1].loop}) ? 1 : 0)`},mod:{setup:(e,t)=>"",loop:(e,t)=>`(${t[0].loop} % ${t[1].loop})`},add:{setup:(e,t)=>"",loop:(e,t)=>`(${t[0].loop} + ${t[1].loop})`},mul:{setup:(e,t)=>"",loop:(e,t)=>`(${t[0].loop} * ${t[1].loop})`},sub:{setup:(e,t)=>"",loop:(e,t)=>`(${t[0].loop} - ${t[1].loop})`},div:{setup:(e,t)=>"",loop:(e,t)=>`(${t[1].loop} != 0 ? ${t[0].loop}/${t[1].loop} : 0)`},pow:{setup:(e,t)=>"",loop:(e,t)=>`Math.pow(${t[0].loop},${t[1].loop})`},abs:{setup:(e,t)=>"",loop:(e,t)=>`Math.abs(${t[0].loop})`},env:{setup:(e,t)=>`${e} = new Module.maxiEnv();\n                      ${e}.setAttack(${t[1].loop});\n                      ${e}.setDecay(${t[2].loop});\n                      ${e}.setSustain(${t[3].loop});\n                      ${e}.setRelease(${t[4].loop})`,loop:(e,t)=>`${e}.adsr(1,${t[0].loop})`},sum:{setup:(e,t)=>"",loop:(e,t)=>{let o=`(${t[0].loop}`;for(let e=1;e<t.length;e++)o+=`+${t[e].loop}`;return o+")"}},mix:{setup:(e,t)=>"",loop:(e,t)=>{let o=`((${t[0].loop}`;for(let e=1;e<t.length;e++)o+=`+${t[e].loop}`;return o+`)/${t.length})`}},prod:{setup:(e,t)=>"",loop:(e,t)=>{let o=`(${t[0].loop}`;for(let e=1;e<t.length;e++)o+=`*${t[e].loop}`;return o+")"}},blin:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiMap.linlin(${t[0].loop}, -1, 1, ${t[1].loop}, ${t[2].loop})`},ulin:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiMap.linlin(${t[0].loop}, 0, 1, ${t[1].loop}, ${t[2].loop})`},bexp:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiMap.linexp(${t[0].loop}, -1, 1, ${t[1].loop}, ${t[2].loop})`},uexp:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiMap.linexp(${t[0].loop}, 0.0000001, 1, ${t[1].loop}, ${t[2].loop})`},linlin:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiMap.linlin(${t[0].loop}, ${t[1].loop}, ${t[2].loop},${t[3].loop}, ${t[4].loop})`},linexp:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiMap.linexp(${t[0].loop}, ${t[1].loop}, ${t[2].loop}, ${t[3].loop}, ${t[4].loop})`},dist:{setup:(e,t)=>`${e} = new Module.maxiNonlinearity()`,loop:(e,t)=>`${e}.atanDist(${t[0].loop},${t[1].loop})`},softclip:{setup:(e,t)=>`${e} = new Module.maxiNonlinearity()`,loop:(e,t)=>`${e}.softclip(${t[0].loop})`},hardclip:{setup:(e,t)=>`${e} = new Module.maxiNonlinearity()`,loop:(e,t)=>`${e}.hardclip(${t[0].loop})`},asymclip:{setup:(e,t)=>`${e} = new Module.maxiNonlinearity()`,loop:(e,t)=>`${e}.asymclip(${t[0].loop},${t[1].loop},${t[2].loop})`},flange:{setup:(e,t)=>`${e} = new Module.maxiFlanger()`,loop:(e,t)=>`${e}.flange(${t[0].loop},${t[1].loop},${t[2].loop},${t[3].loop},${t[4].loop})`},chor:{setup:(e,t)=>`${e} = new Module.maxiChorus()`,loop:(e,t)=>`${e}.chorus(${t[0].loop},${t[1].loop},${t[2].loop},${t[3].loop},${t[4].loop})`},dl:{setup:(e,t)=>`${e} = new Module.maxiDelayline()`,loop:(e,t)=>`${e}.dl(${t[0].loop},${t[1].loop},${t[2].loop})`},lpf:{setup:(e,t)=>`${e} = new Module.maxiFilter()`,loop:(e,t)=>`${e}.lopass(${t[0].loop},${t[1].loop})`},hpf:{setup:(e,t)=>`${e} = new Module.maxiFilter()`,loop:(e,t)=>`${e}.hipass(${t[0].loop},${t[1].loop})`},lpz:{setup:(e,t)=>`${e} = new Module.maxiFilter()`,loop:(e,t)=>`${e}.lores(${t[0].loop},${t[1].loop},${t[2].loop})`},hpz:{setup:(e,t)=>`${e} = new Module.maxiFilter()`,loop:(e,t)=>`${e}.hires(${t[0].loop},${t[1].loop},${t[2].loop})`},scop:{setup:(e,t)=>`${e} = new SABOutputTransducer(outputSABs,\n                                      this.port,\n                                      'scope',\n                                      ${t[1].loop},\n                                      this.currentSample,\n                                      ${3==t.length?1:t[3].loop})`,loop:(e,t)=>`${e}.send(${t[0].loop}, ${t[2].loop})`},toJS:{setup:(e,t)=>`${e} = new SABOutputTransducer(outputSABs,\n                                      this.port,\n                                      'ML',\n                                      ${t[1].loop},\n                                      this.currentSample,\n                                      ${3==t.length?1:t[3].loop})`,loop:(e,t)=>`${e}.send(${t[0].loop}, ${t[2].loop})`},fromJS:{setup:(e,t)=>`${e} = new SABInputTransducer(${t[0].loop}, ${2==t.length?1:0})`,loop:(e,t)=>`${e}.getSABValue(inputSABs, ${2==t.length?t[1].loop:0})`},mouseX:{setup:(e,t)=>"",loop:(e,t)=>"this.getSABValue('mxy')[0]"},mouseY:{setup:(e,t)=>"",loop:(e,t)=>"this.getSABValue('mxy')[1]"},at:{setup:(e,t)=>"",loop:(e,t)=>`${t[0].loop}[Math.min(${t[1].loop}, ${t[0].loop}.length-1)]`},sah:{setup:(e,t)=>`${e} = new Module.maxiSampleAndHold();`,loop:(e,t)=>`${e}.sah(${t[0].loop},${t[1].loop})`},stretch:{setup:(e,t)=>`${e} = new Module.maxiSample();\n                      ${e}.setSample(this.getSampleBuffer(${t[4].loop}));\n                      ${e}stretch = new Module.maxiStretch();\n                      ${e}stretch.setSample(${e});`,loop:(e,t)=>`(${e}.isReady() ? ${e}stretch.play(${t[0].loop},${t[1].loop},${t[2].loop},${t[3].loop},0.0) : 0.0)`},adc:{setup:(e,t)=>"",loop:(e,t)=>`(inputs * ${t[0].loop})`},sampler:{setup:(e,t)=>`${e} = new Module.maxiSample();\n                      ${e}.setSample(this.getSampleBuffer(${t[t.length-1].loop}));`,loop:(e,t)=>{let o="";switch(t.length){case 2:o=`playOnZX(${t[0].loop})`;break;case 3:o=`playOnZXAtSpeed(${t[0].loop},${t[1].loop})`;break;case 4:o=`playOnZXAtSpeedFromOffset(${t[0].loop},${t[1].loop},${t[2].loop})`}return`(${e}.isReady() ? ${e}.${o} : 0.0)`}},loop:{setup:(e,t)=>`${e} = new Module.maxiSample();\n                      ${e}.setSample(this.getSampleBuffer(${t[1].loop}));`,loop:(e,t)=>`(${e}.isReady() ? ${e}.play(${t[0].loop}) : 0.0)`},slice:{setup:(e,t)=>`${e} = new Module.maxiSample();\n                      ${e}.setSample(this.getSampleBuffer(${t[2].loop}));`,loop:(e,t)=>`(${e}.isReady() ? ${e}.loopSetPosOnZX(${t[0].loop},${t[1].loop}) : 0.0)`},oscin:{setup:(e,t)=>"",loop:(e,t)=>`this.OSCTransducer(${t[0].loop},${t[1].loop})`},oscout:{setup:(e,t)=>"",loop:(e,t)=>`this.OSCTransducer(${t[0].loop},${t[1].loop})`},sah:{setup:(e,t)=>`${e} = new Module.maxiSampleAndHold();`,loop:(e,t)=>`${e}.sah(${t[0].loop},${t[1].loop})`},stretch:{setup:(e,t)=>`${e} = new Module.maxiSample();\n                      ${e}.setSample(this.getSampleBuffer(${t[4].loop}));\n                      ${e}stretch = new Module.maxiStretch();\n                      ${e}stretch.setSample(${e});`,loop:(e,t)=>`(${e}.isReady() ? ${e}stretch.play(${t[0].loop},${t[1].loop},${t[2].loop},${t[3].loop},0.0) : 0.0)`},bitToSig:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.toSignal(${t[0].loop})`},bitToTrigSig:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.toTrigSignal(${t[0].loop})`},bitNeg:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.neg(${t[0].loop})`},bitInc:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.inc(${t[0].loop})`},bitDec:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.dec(${t[0].loop})`},bitAnd:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.land(${t[0].loop},${t[1].loop})`},bitOr:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.lor(${t[0].loop},${t[1].loop})`},bitXor:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.lxor(${t[0].loop},${t[1].loop})`},bitShl:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.shl(${t[0].loop},${t[1].loop})`},bitShr:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.shr(${t[0].loop},${t[1].loop})`},bitAt:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.at(${t[0].loop},${t[1].loop})`},bitAdd:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.add(${t[0].loop},${t[1].loop})`},bitSub:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.sub(${t[0].loop},${t[1].loop})`},bitMul:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.mul(${t[0].loop},${t[1].loop})`},bitEq:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.eq(${t[0].loop},${t[1].loop})`},bitGt:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.gt(${t[0].loop},${t[1].loop})`},bitGte:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.gte(${t[0].loop},${t[1].loop})`},bitLte:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.lte(${t[0].loop},${t[1].loop})`},bitLt:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.lt(${t[0].loop},${t[1].loop})`},setup:(e,t)=>"",bitDiv:{loop:(e,t)=>`Module.maxiBits.div(${t[0].loop},${t[1].loop})`},bitr:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.at(${t[0].loop},${t[1].loop},${t[2].loop})`},bitnoise:{setup:(e,t)=>"",loop:(e,t)=>"Module.maxiBits.noise()"},btime:{setup:(e,t)=>"",loop:(e,t)=>"this.bitTime"},bitFromSig:{setup:(e,t)=>"",loop:(e,t)=>`Module.maxiBits.fromSignal(${t[0].loop})`},clp:{setup:(e,t)=>"",loop:(e,t)=>`this.clockPhase(${t[0].loop},${t.length>1?t[1].loop:0})`},clt:{setup:(e,t)=>"",loop:(e,t)=>`this.clockTrig(${t[0].loop},${t.length>1?t[1].loop:0})`},clk:{setup:(e,t)=>"",loop:(e,t)=>`(()=>{this.setBPM(${t[0].loop}); this.setBeatsPerBar(${t[1].loop});})()`},quantise:{setup:(e,t)=>`this.setCodeQuantiseMode(${t[0].loop>0?0:1})`,loop:(e,t)=>""},onzx:{setup:(e,t)=>`${e} = new Module.maxiTrigger();`,loop:(e,t)=>`${e}.onZX(${t[0].loop})`},onchange:{setup:(e,t)=>`${e} = new Module.maxiTrigger();`,loop:(e,t)=>`${e}.onChanged(${t[0].loop},${t[1].loop})`},count:{setup:(e,t)=>`${e} = new Module.maxiCounter();`,loop:(e,t)=>`${e}.count(${t[0].loop},${t[1].loop})`},idx:{setup:(e,t)=>`${e} = new Module.maxiIndex();`,loop:(e,t)=>`${e}.pull(${t[0].loop},${t[1].loop},${t[2].loop})`},svf:{setup:(e,t)=>`${e} = new Module.maxiSVF();\n                      ${e}_p1 = new Module.maxiTrigger();\n                      ${e}_p2 = new Module.maxiTrigger();`,loop:(e,t)=>`( () => { ${e}_cutoff = ${t[1].loop};\n                                if (${e}_p1.onChanged(${e}_cutoff, 1e-5)) {${e}.setCutoff(${e}_cutoff)};\n                                ${e}_res = ${t[2].loop};\n                                if (${e}_p2.onChanged(${e}_res, 1e-5)) {${e}.setResonance(${e}_res)};\n                                return ${e}.play(${t[0].loop},${t[3].loop},${t[4].loop},${t[5].loop},${t[6].loop})})()`},bitclock:{setup:(e,t)=>"",loop:(e,t)=>"this.bitclock"},pvshift:{setup:(e,t)=>`${e} = new pvshift();`,loop:(e,t)=>`${e}.play(${t[0].loop},${t[1].loop})`},rsq:{setup:(e,t)=>`${e} = new Module.maxiRatioSeq();`,loop:(e,t)=>2==t.length?`${e}.playTrig(${t[0].loop},${t[1].loop})`:`${e}.playValues(${t[0].loop},${t[1].loop},${t[2].loop})`},o303:{setup:(e,t)=>`${e} = new Module.Open303();\n                      ${e}.setSampleRate(sampleRate);\n                      ${e}_tnote = new Module.maxiTrigger();\n                      ${e}_twf = new Module.maxiTrigger();\n                      ${e}_tcut = new Module.maxiTrigger();\n                      ${e}_tres = new Module.maxiTrigger();\n                      ${e}_tenvm = new Module.maxiTrigger();\n                      ${e}_tdec = new Module.maxiTrigger();\n                      ${e}_tnoteoff = new Module.maxiTrigger();\n                      ${e}_tatt = new Module.maxiTrigger();`,loop:(e,t)=>`(()=>{\n\t\t\tlet newNote = ${e}_tnote.onZX(${t[0].loop});\n\t\t\tlet accent = ${t[3].loop};\n\t\t\tif (newNote) {\n\t\t\t\tif (${t[2].loop}>0) {\n\t\t\t\t\t${e}.slideToNote(${t[1].loop},accent);\n\t\t\t\t}else{\n\t\t\t\t\t${e}.triggerNote(${t[1].loop},accent);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (${e}_tnoteoff.onChanged(${t[4].loop}, 1e-5)) {${e}.allNotesOff()};\n\t\t\tif (${e}_twf.onChanged(${t[5].loop}, 1e-5)) {${e}.setWaveform(${t[5].loop})};\n\t\t\tif (${e}_tcut.onChanged(${t[6].loop}, 1e-5)) {${e}.setCutoff(${t[6].loop})};\n\t\t\tif (${e}_tres.onChanged(${t[7].loop}, 1e-5)) {${e}.setResonance(${t[7].loop})};\n\t\t\tif (${e}_tenvm.onChanged(${t[8].loop}, 1e-5)) {${e}.setEnvMod(${t[8].loop})};\n\t\t\tif (${e}_tatt.onChanged(${t[9].loop}, 1e-5)) {${e}.setNormalAttack(${t[9].loop})};\n\t\t\tif (${e}_tdec.onChanged(${t[10].loop}, 1e-5)) {${e}.setDecay(${t[10].loop})};\n\t\t\t${e}.setAccent(${t[11].loop});\n\t\t\treturn ${e}.play();})()`},freeverb:{setup:(e,t)=>`${e} = new Module.maxiFreeVerb();`,loop:(e,t)=>`${e}.play(${t[0].loop},${t[1].loop},${t[2].loop})`},line:{setup:(e,t)=>`${e} = new Module.maxiLine(); ${e}.prepare(0,1,${t[1].loop}, false); ${e}.triggerEnable(1);`,loop:(e,t)=>`${e}.play(${t[0].loop})`},const:{setup:(e,t)=>"",loop:(e,t)=>`${t[0].loop}`},poll:{setup:(e,t)=>`${e} = new poll()`,loop:(e,t)=>`${e}.play(${t[0].loop})`},dac:{setup:(e,t)=>"",loop:(e,t)=>1==t.length?`this.dacOutAll(${t[0].loop})`:`this.dacOut(${t[0].loop},${t[1].loop})`},fft:{setup:(e,t)=>`${e} = new fft(${t[1].loop}, ${t[2].loop})`,loop:(e,t)=>`${e}.play(${t[0].loop})`},ifft:{setup:(e,t)=>`${e} = new ifft(${t[3].loop}, ${t[4].loop})`,loop:(e,t)=>`${e}.play(${t[0].loop}, ${t[1].loop}, ${t[2].loop})`},mfcc:{setup:(e,t)=>`${e} = new mfcc(${t[1].loop}, ${t[2].loop}, ${t[3].loop})`,loop:(e,t)=>`${e}.play(${t[0].loop})`},sinb:genBlepOsc(0),cosb:genBlepOsc(1),trib:genBlepOsc(2),sqrb:genBlepOsc(3),rectb:genBlepOsc(4),sawb:genBlepOsc(5),rampb:genBlepOsc(6),modtrib:genBlepOsc(7),modsqrb:genBlepOsc(8),hrecsinb:genBlepOsc(9),frecsinb:genBlepOsc(10),tripulb:genBlepOsc(11),trapb:genBlepOsc(12),vtrapb:genBlepOsc(13),polyblep:{setup:(e,t)=>`${e} = new Maximilian.maxiPolyBLEP();`,loop:(e,t)=>2==t.length?`(()=>{${e}.setWaveform(${t[1].loop}); return ${e}.play(${t[0].loop});})()`:`(()=>{${e}.setPulseWidth(${t[2].loop}); ${e}.setWaveform(${t[1].loop});  return ${e}.play(${t[0].loop});})()`}};class ASTreeToJavascript{static getNextID(){return objectID=objectID>9999?0:++objectID}static emptyCode(){return{setup:"",loop:"",paramMarkers:[]}}static traverseTree(e,t,o,r,n){let s={"@lang":(e,t)=>(t.map((t=>{let s=ASTreeToJavascript.traverseTree(t,ASTreeToJavascript.emptyCode(),o,r,n);e.setup+=s.setup,e.loop+=s.loop})),e),"@spawn":(e,t)=>((e=ASTreeToJavascript.traverseTree(t,e,o,r,n)).loop+=";",e),"@sigp":(e,t)=>{let s=[{s:t.paramBegin,e:t.paramEnd,l:o}];e.paramMarkers=e.paramMarkers.concat(s);let a=t["@func"].value,i=jsFuncMap[a],l="q.b"+n+"u"+ASTreeToJavascript.getNextID(),p=[];for(let e=0;e<t["@params"].length;e++){let s=ASTreeToJavascript.emptyCode();s=ASTreeToJavascript.traverseTree(t["@params"][e],s,o+1,r,n),p[e]=s}let u="";for(let t in p)u+=p[t].setup,e.paramMarkers=e.paramMarkers.concat(p[t].paramMarkers);return e.setup+=`${u} ${i.setup(l,p)};`,e.loop+=`${i.loop(l,p)}`,e},"@setvar":(e,t)=>{let s=t["@varname"],a=r[s];null==a&&(a=Object.keys(r).length,r[s]=a);let i=ASTreeToJavascript.traverseTree(t["@varvalue"],ASTreeToJavascript.emptyCode(),o+1,r,n);return e.setup+=i.setup,e.loop=`(mem[${a}] = ${i.loop})`,e},"@getvar":(e,t)=>{let o=r[t];return null==o&&(o=Object.keys(r).length,r[t]=o),e.loop+=`(mem[${o}] != undefined ? mem[${o}] : 0)`,e},"@string":(e,t)=>(("string"==typeof t||t instanceof String)&&(e.loop+=`'${t}'`),e),"@num":(e,t)=>(null!=t.value&&(e.loop+=`${t.value}`),e),"@list":(e,t)=>{let s="q.b"+n+"l"+ASTreeToJavascript.getNextID();e.setup+=`${s} = new Float64Array(${t.length});`,e.loop+="(()=>{";let a="";for(let i=0;i<t.length;i++){let l=ASTreeToJavascript.traverseTree(t[i],ASTreeToJavascript.emptyCode(),o,r,n);"@num"==Object.keys(t[i])[0]?e.setup+=`${s}[${i}] = ${l.loop};`:(a+=l.setup,e.loop+=`${s}[${i}] = ${l.loop};`)}return e.loop+=`return ${s}})()`,e.setup+=a,e}};return Array.isArray(e)?e.map((e=>{Object.keys(e).map((o=>{t=s[o](t,e[o])}))})):Object.keys(e).map((o=>{t=s[o](t,e[o])})),t}static treeToCode(e,t=0){vars={};let o=ASTreeToJavascript.traverseTree(e,ASTreeToJavascript.emptyCode(),0,vars,t);return o.setup=`() => {let q=this.newq(); ${o.setup}; return q;}`,o.loop=`(q, inputs, mem) => {${o.loop}}`,console.log(o.setup),console.log(o.loop),o}}var IR=Object.freeze({__proto__:null,default:ASTreeToJavascript}),sema=createCommonjsModule((function(e){var t;t=commonjsGlobal,e.exports?e.exports={num:function(e){return{"@num":{value:e}}},str:function(e){return{"@string":e}},synth:function(e,t){return{"@sigp":{"@params":t,"@func":{value:e}}}},setvar:function(e,t){return{"@setvar":{"@varname":e,"@varvalue":t}}},getvar:function(e){return{"@getvar":e}}}:t.sema={num:function(e){return{"@num":{value:e}}},str:function(e){return{"@string":e}},synth:function(e,t){return{"@sigp":{"@params":t,"@func":{value:e}}}},setvar:function(e,t){return{"@setvar":{"@varname":e,"@varvalue":t}}},getvar:function(e){return{"@getvar":e}}}}));function getParserModuleExports(source){let sema$1=sema;sema$1.num("3");let module={exports:""};return eval(source),module.exports}function compile(e,t){try{let o;const{errors:r,output:n}=compileGrammar(e),s=getParserModuleExports(n),a=new nearley.Parser(s);if(!r&&a){const e=a.feed(t);e&&(o=ASTreeToJavascript.treeToCode(e.results,0))}return{dspCode:o}}catch(e){return{errors:e}}}function parse(e,t){try{const{errors:o,output:r}=compileGrammar(e),n=getParserModuleExports(r),s=new nearley.Parser(n);if(!o&&s){return{livecodeParseTree:s.feed(t).results}}return{errors:o}}catch(e){return{errors:e}}}function ASTreeToDSPcode(e){if(!e)throw new Error("Problem with livecodeParseTree argument passed to ASTreeToDSPCode");try{return{dspCode:ASTreeToJavascript.treeToCode(e,0)}}catch(e){return{errors:e}}}function stream(){let e="";return{write(t){e+=t},dump:()=>e}}function AnnotatePositions(e){return e.map((e=>new nearley.Rule(e.name,e.symbols,e.postprocess&&((t,o,r)=>{var n=e.postprocess(t,o,r);return null===n?null:("object"!=typeof n||n.slice||(n.pos=o),n)}))))}function compileGrammar(e){let t=new nearley.Parser(AnnotatePositions(nearleyLanguageBootstrapped.ParserRules),nearleyLanguageBootstrapped.ParserStart,{lexer:nearleyLanguageBootstrapped.Lexer}),o=stream(),r="",n={};try{if(t.feed(e),t.results[0]){function e(e,t,o){n[e]=[t,o]}var s=compileLowLevel(t.results[0],{rangeCallback:e});lint_1(s,{out:o}),r=generate(s,"grammar")}}catch(e){o.write(e)}return{errors:o.dump(),positions:n,output:r}}var WorkerClass=null;try{var WorkerThreads="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");WorkerClass=WorkerThreads.Worker}catch(e){}function decodeBase64$1(e,t){return Buffer.from(e,"base64").toString(t?"utf16":"utf8")}function createBase64WorkerFactory$2(e,t,o){var r=void 0===t?null:t,n=decodeBase64$1(e,void 0!==o&&o),s=n.indexOf("\n",10)+1,a=n.substring(s)+(r?"//# sourceMappingURL="+r:"");return function(e){return new WorkerClass(a,Object.assign({},e,{eval:!0}))}}function decodeBase64(e,t){var o=atob(e);if(t){for(var r=new Uint8Array(o.length),n=0,s=o.length;n<s;++n)r[n]=o.charCodeAt(n);return String.fromCharCode.apply(null,new Uint16Array(r.buffer))}return o}function createURL(e,t,o){var r=void 0===t?null:t,n=decodeBase64(e,void 0!==o&&o),s=n.indexOf("\n",10)+1,a=n.substring(s)+(r?"//# sourceMappingURL="+r:""),i=new Blob([a],{type:"application/javascript"});return URL.createObjectURL(i)}function createBase64WorkerFactory$1(e,t,o){var r;return function(n){return r=r||createURL(e,t,o),new Worker(r,n)}}var kIsNodeJS="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);function isNodeJS(){return kIsNodeJS}function createBase64WorkerFactory(e,t,o){return isNodeJS()?createBase64WorkerFactory$2(e,t,o):createBase64WorkerFactory$1(e,t,o)}var WorkerFactory=createBase64WorkerFactory("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwohZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7Y2xhc3MgZXtzdGF0aWMgZ2V0U3RvcmFnZUZvckNhcGFjaXR5KGUsdCl7aWYoIXQuQllURVNfUEVSX0VMRU1FTlQpdGhyb3ciUGFzcyBpbiBhIEFycmF5QnVmZmVyIHN1YmNsYXNzIjt2YXIgYT04KyhlKzEpKnQuQllURVNfUEVSX0VMRU1FTlQ7cmV0dXJuIG5ldyBTaGFyZWRBcnJheUJ1ZmZlcihhKX1jb25zdHJ1Y3RvcihlLHQpe2lmKCFBcnJheUJ1ZmZlci5fX3Byb3RvX18uaXNQcm90b3R5cGVPZih0KSYmdm9pZCAwIT09dC5CWVRFU19QRVJfRUxFTUVOVCl0aHJvdyJQYXNzIGEgY29uY3JldGUgdHlwZWQgYXJyYXkgY2xhc3MgYXMgc2Vjb25kIGFyZ3VtZW50Ijt0aGlzLl90eXBlPXQsdGhpcy5jYXBhY2l0eT0oZS5ieXRlTGVuZ3RoLTgpL3QuQllURVNfUEVSX0VMRU1FTlQsdGhpcy5idWY9ZSx0aGlzLndyaXRlX3B0cj1uZXcgVWludDMyQXJyYXkodGhpcy5idWYsMCwxKSx0aGlzLnJlYWRfcHRyPW5ldyBVaW50MzJBcnJheSh0aGlzLmJ1Ziw0LDEpLHRoaXMuc3RvcmFnZT1uZXcgdCh0aGlzLmJ1Ziw4LHRoaXMuY2FwYWNpdHkpfXR5cGUoKXtyZXR1cm4gdGhpcy5fdHlwZS5uYW1lfXB1c2goZSl7dmFyIHQ9QXRvbWljcy5sb2FkKHRoaXMucmVhZF9wdHIsMCksYT1BdG9taWNzLmxvYWQodGhpcy53cml0ZV9wdHIsMCk7aWYoKGErMSkldGhpcy5fc3RvcmFnZV9jYXBhY2l0eSgpPT10KXJldHVybiAwO2xldCBzPU1hdGgubWluKHRoaXMuX2F2YWlsYWJsZV93cml0ZSh0LGEpLGUubGVuZ3RoKSxvPU1hdGgubWluKHRoaXMuX3N0b3JhZ2VfY2FwYWNpdHkoKS1hLHMpLGk9cy1vO3JldHVybiB0aGlzLl9jb3B5KGUsMCx0aGlzLnN0b3JhZ2UsYSxvKSx0aGlzLl9jb3B5KGUsbyx0aGlzLnN0b3JhZ2UsMCxpKSxBdG9taWNzLnN0b3JlKHRoaXMud3JpdGVfcHRyLDAsKGErcykldGhpcy5fc3RvcmFnZV9jYXBhY2l0eSgpKSxzfXBvcChlKXt2YXIgdD1BdG9taWNzLmxvYWQodGhpcy5yZWFkX3B0ciwwKSxhPUF0b21pY3MubG9hZCh0aGlzLndyaXRlX3B0ciwwKTtpZihhPT10KXJldHVybiAwO2xldCBzPU1hdGgubWluKHRoaXMuX2F2YWlsYWJsZV9yZWFkKHQsYSksZS5sZW5ndGgpLG89TWF0aC5taW4odGhpcy5fc3RvcmFnZV9jYXBhY2l0eSgpLXQsZS5sZW5ndGgpLGk9cy1vO3JldHVybiB0aGlzLl9jb3B5KHRoaXMuc3RvcmFnZSx0LGUsMCxvKSx0aGlzLl9jb3B5KHRoaXMuc3RvcmFnZSwwLGUsbyxpKSxBdG9taWNzLnN0b3JlKHRoaXMucmVhZF9wdHIsMCwodCtzKSV0aGlzLl9zdG9yYWdlX2NhcGFjaXR5KCkpLHN9ZW1wdHkoKXt2YXIgZT1BdG9taWNzLmxvYWQodGhpcy5yZWFkX3B0ciwwKTtyZXR1cm4gQXRvbWljcy5sb2FkKHRoaXMud3JpdGVfcHRyLDApPT1lfWZ1bGwoKXt2YXIgZT1BdG9taWNzLmxvYWQodGhpcy5yZWFkX3B0ciwwKTtyZXR1cm4oQXRvbWljcy5sb2FkKHRoaXMud3JpdGVfcHRyLDApKzEpJXRoaXMuY2FwYWNpdHkhPWV9Y2FwYWNpdHkoKXtyZXR1cm4gdGhpcy5jYXBhY2l0eS0xfWF2YWlsYWJsZV9yZWFkKCl7dmFyIGU9QXRvbWljcy5sb2FkKHRoaXMucmVhZF9wdHIsMCksdD1BdG9taWNzLmxvYWQodGhpcy53cml0ZV9wdHIsMCk7cmV0dXJuIHRoaXMuX2F2YWlsYWJsZV9yZWFkKGUsdCl9YXZhaWxhYmxlX3dyaXRlKCl7dmFyIGU9QXRvbWljcy5sb2FkKHRoaXMucmVhZF9wdHIsMCksdD1BdG9taWNzLmxvYWQodGhpcy53cml0ZV9wdHIsMCk7cmV0dXJuIHRoaXMuX2F2YWlsYWJsZV93cml0ZShlLHQpfV9hdmFpbGFibGVfcmVhZChlLHQpe3JldHVybiB0PmU/dC1lOnQrdGhpcy5fc3RvcmFnZV9jYXBhY2l0eSgpLWV9X2F2YWlsYWJsZV93cml0ZShlLHQpe2xldCBhPWUtdC0xO3JldHVybiB0Pj1lJiYoYSs9dGhpcy5fc3RvcmFnZV9jYXBhY2l0eSgpKSxhfV9zdG9yYWdlX2NhcGFjaXR5KCl7cmV0dXJuIHRoaXMuY2FwYWNpdHl9X2NvcHkoZSx0LGEscyxvKXtmb3IodmFyIGk9MDtpPG87aSsrKWFbcytpXT1lW3QraV19fXNlbGYuUmluZ0J1ZmZlcj1lO3ZhciB0LGEscyxvLGk9e307c2VsZi5jb25zb2xlJiYoc2VsZi5jb25zb2xlLmxvZyYmKHQ9Y29uc29sZS5sb2cpLHNlbGYuY29uc29sZS5sb2cmJihhPWNvbnNvbGUuaW5mbyksc2VsZi5jb25zb2xlLmxvZyYmKHM9Y29uc29sZS53YXJuKSxzZWxmLmNvbnNvbGUubG9nJiYobz1jb25zb2xlLmVycm9yKSx0JiZhJiZzJiZvJiYocygidGFraW5nIG92ZXIgY29uc29sZSIpLGNvbnNvbGUubG9nPWZ1bmN0aW9uKCl7c2VsZi5wb3N0TWVzc2FnZSh7ZnVuYzoibG9ncyIscGF5bG9hZDpbLi4uYXJndW1lbnRzXSx0eXBlOiJbTEVBUk5FUiBXT1JLRVJdIn0pLHQuYXBwbHkodGhpcyxhcmd1bWVudHMpfSxjb25zb2xlLmluZm89ZnVuY3Rpb24oZSl7c2VsZi5wb3N0TWVzc2FnZSh7ZnVuYzoibG9ncyIscGF5bG9hZDpbLi4uYXJndW1lbnRzXSx0eXBlOiJbTEVBUk5FUiBXT1JLRVJdIn0pLGEuYXBwbHkodGhpcyxhcmd1bWVudHMpfSxjb25zb2xlLndhcm49ZnVuY3Rpb24oZSl7c2VsZi5wb3N0TWVzc2FnZSh7ZnVuYzoibG9ncyIscGF5bG9hZDpbLi4uYXJndW1lbnRzXSx0eXBlOiJbTEVBUk5FUiBXT1JLRVJdIn0pLHMuYXBwbHkodGhpcyxhcmd1bWVudHMpfSxjb25zb2xlLmVycm9yPWZ1bmN0aW9uKGUpe3NlbGYucG9zdE1lc3NhZ2Uoe2Z1bmM6ImxvZ3MiLHBheWxvYWQ6Wy4uLmFyZ3VtZW50c10sdHlwZToiW0xFQVJORVIgV09SS0VSXSJ9KSxvLmFwcGx5KHRoaXMsYXJndW1lbnRzKX0sbygiY29uc29sZSB0YWtlbiBvdmVyIikpKTtjbGFzcyBye2NvbnN0cnVjdG9yKHQsYSxzKXt0aGlzLmNoYW5uZWw9YSx0aGlzLmJsb2Nrc2l6ZT1zLGEgaW4gaSYmaVthXS5ibG9ja3NpemU9PXM/dGhpcy5yaW5nYnVmPWlbYV0ucmI6KHRoaXMuc2FiPWUuZ2V0U3RvcmFnZUZvckNhcGFjaXR5KDMyKnMsRmxvYXQ2NEFycmF5KSx0aGlzLnJpbmdidWY9bmV3IGUodGhpcy5zYWIsRmxvYXQ2NEFycmF5KSxpW2FdPXtyYjp0aGlzLnJpbmdidWYsc2FiOnRoaXMuc2FiLGNyZWF0ZWQ6RGF0ZS5ub3coKSxibG9ja3NpemU6c30scG9zdE1lc3NhZ2Uoe2Z1bmM6InNhYiIsdmFsdWU6dGhpcy5zYWIsdHR5cGU6dCxjaGFubmVsSUQ6YSxibG9ja3NpemU6c30pKX1zZW5kKGUpe2lmKHRoaXMucmluZ2J1Zi5hdmFpbGFibGVfd3JpdGUoKT4xKWlmKCJudW1iZXIiPT10eXBlb2YgZSl0aGlzLnJpbmdidWYucHVzaChuZXcgRmxvYXQ2NEFycmF5KFtlXSkpO2Vsc2UgaWYoZS5sZW5ndGg9PXRoaXMuYmxvY2tzaXplKXRoaXMucmluZ2J1Zi5wdXNoKGUpO2Vsc2UgaWYoZS5sZW5ndGg8dGhpcy5ibG9ja3NpemUpe2xldCB0PW5ldyBGbG9hdDY0QXJyYXkodGhpcy5ibG9ja3NpemUpO2ZvcihsZXQgYSBpbiBlKXRbYV09ZVthXTt0aGlzLnJpbmdidWYucHVzaCh0KX1lbHNlIHRoaXMucmluZ2J1Zi5wdXNoKGUuc2xpY2UoMCx0aGlzLmJsb2Nrc2l6ZSkpfX1zZWxmLmNyZWF0ZU91dHB1dENoYW5uZWw9KGUsdCk9Pm5ldyByKCJNTCIsZSx0KSxzZWxmLmlucHV0PShlLHQpPT57fSxzZWxmLm91dHB1dD0oZSx0KT0+e3Bvc3RNZXNzYWdlKHtmdW5jOiJkYXRhIix2YWw6ZSxjaDp0fSl9LHNlbGYubG9hZFJlc3BvbmRlcnM9e30sc2VsZi5pbnB1dFNBQnM9e30sc2VsZi5zZW1hPXtzYXZlRjMyQXJyYXk6KGUsdCk9Pihwb3N0TWVzc2FnZSh7ZnVuYzoic2F2ZSIsbmFtZTplLHZhbDp0fSksMCksbG9hZEYzMkFycmF5OihlLHQpPT4ocG9zdE1lc3NhZ2Uoe2Z1bmM6ImxvYWQiLG5hbWU6ZX0pLGxvYWRSZXNwb25kZXJzW2VdPXQsMCksZG93bmxvYWQ6ZT0+e3Bvc3RNZXNzYWdlKHtmdW5jOiJkb3dubG9hZCIsbmFtZTplfSl9LHNlbmRDb2RlOmU9Pntwb3N0TWVzc2FnZSh7ZnVuYzoic2VuZGNvZGUiLGNvZGU6ZX0pfSxwYmNvcHk6ZT0+e3Bvc3RNZXNzYWdlKHtmdW5jOiJwYmNvcHkiLG1zZzplfSl9LHNlbmRCdWZmZXI6KGUsdCk9Pntwb3N0TWVzc2FnZSh7ZnVuYzoic2VuZGJ1ZiIsbmFtZTplLGRhdGE6dH0pfSxlbnY6e3NhdmVMb2NhbDplPT57cG9zdE1lc3NhZ2Uoe2Z1bmM6ImVudnNhdmUiLG5hbWU6ZSxzdG9yYWdlOiJsb2NhbCJ9KX0sbG9hZExvY2FsOmU9Pntwb3N0TWVzc2FnZSh7ZnVuYzoiZW52bG9hZCIsbmFtZTplLHN0b3JhZ2U6ImxvY2FsIn0pfSxzYXZlVG9QQjooKT0+e3Bvc3RNZXNzYWdlKHtmdW5jOiJlbnZzYXZlIixzdG9yYWdlOiJwYXN0ZWJ1ZmZlciJ9KX0sbG9hZEdpc3Q6ZT0+e3Bvc3RNZXNzYWdlKHtmdW5jOiJlbnZsb2FkIixuYW1lOmUsc3RvcmFnZToiZ2lzdCJ9KX19LGRvbWV2YWw6ZT0+e3Bvc3RNZXNzYWdlKHtmdW5jOiJkb21ldmFsIixjb2RlOmV9KX0scGVlcmluZm86KCk9Pntwb3N0TWVzc2FnZSh7ZnVuYzoicGVlcmluZm8ifSksY29uc29sZS5sb2coIllvdXIgcGVlciBJRCBoYXMgYmVlbiBjb3BpZWQgdG8gdGhlIHBhc3RlIGJ1ZmZlciIpfX07ZnVuY3Rpb24gbCgpe3RyeXtmb3IobGV0IGUgaW4gaW5wdXRTQUJzKXtsZXQgdD1pbnB1dFNBQnNbZV0ucmIuYXZhaWxhYmxlX3JlYWQoKTtpZih0IT1pbnB1dFNBQnNbZV0ucmIuY2FwYWNpdHkmJnQ+MClmb3IobGV0IGE9MDthPHQ7YSs9aW5wdXRTQUJzW2VdLmJsb2Nrc2l6ZSl7bGV0IHQ9bmV3IEZsb2F0NjRBcnJheShpbnB1dFNBQnNbZV0uYmxvY2tzaXplKTtpbnB1dFNBQnNbZV0ucmIucG9wKHQpLGlucHV0KGUsdCl9fXNldFRpbWVvdXQobCwyMCl9Y2F0Y2goZSl7c2V0VGltZW91dChsLDEwMCl9fW9ubWVzc2FnZT10PT57aWYodC5kYXRhLnVybCkhZnVuY3Rpb24oZSl7aWYobmV3IFVSTChlKSl7dHJ5e2woKX1jYXRjaChlKXtjb25zb2xlLmVycm9yKCJFUlJPUjogc2FiQ2hlY2tlciIsZSl9cG9zdE1lc3NhZ2Uoe2luaXQ6ITB9KX1lbHNlIGNvbnNvbGUuZXJyb3IoIkVSUk9SOiBpbml0V2l0aFVSTCDigJMgSW52YWxpZCBVUkwiKX0odC5kYXRhLnVybCk7ZWxzZSBpZih0LmRhdGEuZXZhbCkoZT0+e3RyeXtpZighdCl2YXIgdD1ldmFsO2xldCBhPXQoZSk7dm9pZCAwIT09YT9jb25zb2xlLmluZm8oYSk6Y29uc29sZS5pbmZvKCJkb25lIil9Y2F0Y2goZSl7Y29uc29sZS5lcnJvcigiRXZhbCBleGNlcHRpb24gb24gTGVhcm5lcjogIixlKX19KSh0LmRhdGEuZXZhbCk7ZWxzZSBpZigidmFsImluIHQuZGF0YSl7bGV0IGU9dC5kYXRhLnZhbDtlPUpTT04ucGFyc2UoYFske2V9XWApLGxvYWRSZXNwb25kZXJzW3QuZGF0YS5uYW1lXShlKSxkZWxldGUgbG9hZFJlc3BvbmRlcnNbdC5kYXRhLm5hbWVdfWVsc2UgaWYoIm1vZGVsLWlucHV0LWRhdGEiPT09dC5kYXRhLnR5cGUpaW5wdXQodC5kYXRhLnZhbHVlLHQuZGF0YS5jaCk7ZWxzZSBpZih0LmRhdGEuc2FiKXtjb25zb2xlLmluZm8oImJ1ZmZlciByZWNlaXZlZCIpO2xldCBhPXQuZGF0YS5zYWIscz1uZXcgZShhLEZsb2F0NjRBcnJheSk7aW5wdXRTQUJzW3QuZGF0YS5jaGFubmVsSURdPXtzYWI6YSxyYjpzLGJsb2Nrc2l6ZTp0LmRhdGEuYmxvY2tzaXplfX19fSgpOwoK",null,!1);class Learner{constructor(){this.dispatcher=new Dispatcher,this.logger=new Logger}addEventListener(e,t){if(!(this.dispatcher&&e&&t))throw new Error("Error adding event listener to Learner");this.dispatcher.addEventListener(e,t)}removeEventListener(e,t){if(!(this.dispatcher&&e&&t))throw new Error("Error removing event listener to Learner");this.dispatcher.removeEventListener(e,t)}async init(e){return this.worker=new WorkerFactory,new Promise(((t,o)=>{let r={};this.worker&&new URL(e)&&(this.worker.postMessage({url:e}),this.worker.onerror=e=>{console.log("onError"),o(e)},this.worker.onmessage=e=>{r=e.data.init,console.info("running Learner"),t(r),this.worker.onmessage=this.onMessageHandler.bind(this)})}))}onMessageHandler(e){if(e&&e.data&&e.data.func){({sab:e=>{this.dispatcher.dispatch("onSharedBuffer",e)},sendbuf:e=>{this.dispatcher.dispatch("onSharedBuffer",e)},save:e=>{window.localStorage.setItem(e.name,e.val)},load:e=>{let t={name:e.name,val:window.localStorage.getItem(e.name)};modelWorker.postMessage(t)},download:e=>{let t=window.localStorage.getItem(e.name),o=new Blob([t],{type:"text/plain;charset=utf-8"});saveData(o,`${e.name}.data`)},sendcode:e=>{},data:()=>{},pbcopy:e=>{copyToPasteBuffer(e.msg)},envsave:e=>{messaging.publish("env-save",e)},envload:e=>{messaging.publish("env-load",e)},domeval:e=>{evalDOMCode(e.code)},peerinfo:e=>{messaging.publish("peerinfo-request",{})},logs:e=>{this.logger.push(e)}})[e.data.func](e.data)}else void 0!==e.data&&0!==e.data.length&&console.log(e.data)}eval(e){this.worker&&e&&this.worker.postMessage({eval:e})}addSharedBuffer(e){if(!(this.worker&&e&&e.sab&&e.sab instanceof SharedArrayBuffer))throw new Error("Error pushing SharedBuffer in Learner");this.worker.postMessage({sab:e.sab,blocksize:e.blocksize,channelID:e.channelID})}evalBlock(e){let t=e.indexOf("\n");"//--DOM"==e.substr(0,t)?(e=e.substr(t),evalDomCode(e),addToHistory("dom-history-",e)):(this.worker.postMessage({eval:e}),window.localStorage.setItem("modelEditorValue",codeMirror.getValue()),addToHistory("model-history-",e))}terminate(){this.worker.onmessage=null,this.worker.terminate(),this.worker=null}}function getBlock(e){if(e){let t=e.getCursor(),o=t.line,r=e.lastLine();for(;o<r;){if(/___+/.test(e.getLine(o))){r=o-1;break}o++}o=t.line;let n=-1;for(;o>=0;){if(/___+/.test(e.getLine(o))){n=o;break}o--}return n>-1&&n++,e.getRange({line:n,ch:0},{line:r+1,ch:0})}}exports.ASTreeToDSPcode=ASTreeToDSPcode,exports.ASTreeToJavascript=IR,exports.Engine=Engine,exports.Learner=Learner,exports.Logger=Logger,exports.compile=compile,exports.compileGrammar=compileGrammar,exports.getBlock=getBlock,exports.getParserModuleExports=getParserModuleExports,exports.mooo=moo.mooo,exports.nearley=nearley.nearley,exports.parse=parse,exports.semaa=sema.semaa,Object.defineProperty(exports,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map
